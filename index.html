<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Activity Tracker Pro</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        .pastel-bg { background-color: #f8fafc; }
    </style>
</head>
<body class="bg-[#fdfcfb]">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const CATEGORIES = [
            'IT CRM Activities', 'IT Online Client Acquisition', 'IT Onsite Client Acquisition',
            'IT Tenders', 'INT CRM Activities', 'INT Online Client Acquisition',
            'INT Onsite Client Acquisition', 'INT Tenders', 'Proposal Drafting',
            'Technical Support', 'IT Renewal Activities', 'INT Renewal Activities',
            'Conferences', 'Personal Management', 'Sales & Internal Meetings',
            'Distributor Meetings', 'VarChat BI', 'Competitor Analysis',
            'Personal Training', 'PTO'
        ];

        const HOURS = ['09:00', '10:00', '11:00', '12:00', '14:00', '15:00', '16:00', '17:00'];
        const MONTHS = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

        const Download = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>;
        const Upload = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>;
        const Trash2 = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>;
        const ChevronDown = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="6 9 12 15 18 9"></polyline></svg>;
        const ChevronUp = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="18 15 12 9 6 15"></polyline></svg>;

        function TimesheetTracker() {
            const [currentMonth, setCurrentMonth] = useState(new Date().getMonth());
            const [currentView, setCurrentView] = useState('daily');
            const [saveStatus, setSaveStatus] = useState('');
            const [collapsedDays, setCollapsedDays] = useState({});
            const [lastBackup, setLastBackup] = useState(localStorage.getItem('last-backup-date') || 'Never');
            
            const [timesheet, setTimesheet] = useState(() => {
                const saved = localStorage.getItem('timesheet-v3');
                if (saved) return JSON.parse(saved);
                const initial = { data: {}, weekends: {} };
                MONTHS.forEach((_, m) => {
                    initial.data[m] = {};
                    initial.weekends[m] = {};
                    for (let d = 1; d <= 31; d++) {
                        initial.data[m][d] = {};
                        HOURS.forEach(h => initial.data[m][d][h] = '');
                    }
                });
                return initial;
            });

            useEffect(() => { localStorage.setItem('timesheet-v3', JSON.stringify(timesheet)); }, [timesheet]);

            // Auto-collapse if complete OR weekend
            useEffect(() => {
                const newCollapsed = {};
                const days = getDaysInMonth(currentMonth);
                for (let d = 1; d <= days; d++) {
                    if (isDayDone(currentMonth, d)) newCollapsed[d] = true;
                }
                setCollapsedDays(newCollapsed);
            }, [currentMonth, timesheet]);

            const getDaysInMonth = (m) => new Date(new Date().getFullYear(), m + 1, 0).getDate();

            const isDayDone = (m, d) => {
                const isWeekend = timesheet.weekends[m]?.[d];
                if (isWeekend) return true;
                const dayData = timesheet.data[m]?.[d];
                if (!dayData) return false;
                return HOURS.every(h => dayData[h] && dayData[h].trim() !== '');
            };

            const toggleWeekend = (m, d) => {
                setTimesheet(prev => ({
                    ...prev,
                    weekends: { ...prev.weekends, [m]: { ...prev.weekends[m], [d]: !prev.weekends[m]?.[d] } }
                }));
            };

            const updateActivity = (m, d, h, act) => {
                setTimesheet(prev => ({
                    ...prev,
                    data: { ...prev.data, [m]: { ...prev.data[m], [d]: { ...prev.data[m][d], [h]: act } } }
                }));
            };

            const bulkUpdate = (m, d, act) => {
                if (!act) return;
                const updatedDay = {};
                HOURS.forEach(h => updatedDay[h] = act);
                setTimesheet(prev => ({
                    ...prev,
                    data: { ...prev.data, [m]: { ...prev.data[m], [d]: updatedDay } }
                }));
            };

            const clearDay = (m, d) => {
                if (!confirm(`Clear all entries for Day ${d}?`)) return;
                const emptyDay = {};
                HOURS.forEach(h => emptyDay[h] = '');
                setTimesheet(prev => ({
                    ...prev,
                    data: { ...prev.data, [m]: { ...prev.data[m], [d]: emptyDay } }
                }));
            };

            const exportJSON = () => {
                const dataStr = JSON.stringify(timesheet, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = window.URL.createObjectURL(blob);
                a.download = `timesheet_backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                const now = new Date().toLocaleString();
    setLastBackup(now);
    localStorage.setItem('last-backup-date', now);
            };

            const importJSON = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        setTimesheet(JSON.parse(event.target.result));
                        setSaveStatus('âœ“ Restored');
                        setTimeout(() => setSaveStatus(''), 2000);
                    } catch (err) { alert('Invalid File'); }
                };
                reader.readAsText(file);
            };

            const exportExcel = async () => {
                const workbook = new ExcelJS.Workbook();
                const sheet = workbook.addWorksheet('Report');
                const m = currentMonth;
                const days = getDaysInMonth(m);
                let totals = {};
                CATEGORIES.forEach(c => totals[c] = 0);
                let workHoursDenominator = 0;

                for (let d = 1; d <= days; d++) {
                    const isWeekend = timesheet.weekends[m]?.[d];
                    HOURS.forEach(h => {
                        const act = timesheet.data[m]?.[d]?.[h];
                        if (act) {
                            totals[act]++;
                            if (!isWeekend && act !== 'PTO') workHoursDenominator++;
                        }
                    });
                }

                sheet.columns = [
                    { header: 'Activity', key: 'cat', width: 30 },
                    { header: 'Hours', key: 'hrs', width: 10 },
                    { header: '% Work Time', key: 'perc', width: 15 }
                ];

                Object.entries(totals).filter(([_, h]) => h > 0).forEach(([cat, h]) => {
                    sheet.addRow({ cat, hrs: h, perc: cat === 'PTO' ? 0 : (h / Math.max(workHoursDenominator, 1)) });
                });
                sheet.getColumn('perc').numFmt = '0.0%';
                const buffer = await workbook.xlsx.writeBuffer();
                saveAs(new Blob([buffer]), `${MONTHS[m]}_Sales_Analysis.xlsx`);
            };

            const renderMonthlySummary = () => {
                const totals = {};
                CATEGORIES.forEach(c => totals[c] = 0);
                const days = getDaysInMonth(currentMonth);
                for (let d = 1; d <= days; d++) {
                    HOURS.forEach(h => {
                        const act = timesheet.data[currentMonth]?.[d]?.[h];
                        if (act) totals[act]++;
                    });
                }
                const sorted = Object.entries(totals).filter(([_, h]) => h > 0).sort((a,b) => b[1]-a[1]);
                const totalHours = sorted.reduce((s, [_, h]) => s + h, 0);

                return (
                    <div className="space-y-4">
                        <div className="bg-white rounded-2xl shadow-sm p-8 border border-[#eef2f6]">
                            <h3 className="text-xl font-semibold text-gray-700 mb-6">Monthly Analysis - {MONTHS[currentMonth]}</h3>
                            <div className="bg-[#f0f7ff] p-6 rounded-2xl mb-8 text-[#4a90e2] text-3xl font-bold">{totalHours} Total Hours Logged</div>
                            <div className="space-y-6">
                                {sorted.map(([cat, h]) => (
                                    <div key={cat}>
                                        <div className="flex justify-between text-sm mb-2 text-gray-600 font-medium">
                                            <span>{cat}</span>
                                            <span>{h}h ({((h/totalHours)*100).toFixed(1)}%)</span>
                                        </div>
                                        <div className="w-full bg-[#f1f5f9] rounded-full h-2">
                                            <div className="bg-[#a5b4fc] h-2 rounded-full" style={{width: `${(h/Math.max(...sorted.map(x=>x[1])))*100}%`}}></div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="max-w-5xl mx-auto p-6">
                    <div className="bg-white rounded-3xl shadow-sm p-8 mb-8 border border-[#f1f5f9]">
                        <div className="flex flex-col md:flex-row justify-between items-center gap-6">
                            <div>
                                <h1 className="text-2xl font-bold text-gray-800 tracking-tight">Sales Timesheet</h1>
                                {saveStatus && <span className="text-[#86efac] font-bold text-xs uppercase">{saveStatus}</span>}
                                <p className="text-[10px] text-gray-400 font-medium uppercase mt-1">
        Last Backup: <span className={lastBackup === 'Never' ? 'text-rose-400' : 'text-emerald-400'}>{lastBackup}</span>
    </p>
    {saveStatus && <span className="text-[#86efac] font-bold text-xs uppercase">{saveStatus}</span>}
</div>
                            </div>
                            <div className="flex gap-2 flex-wrap justify-center">
                                <button onClick={exportJSON} className="flex items-center gap-2 bg-[#dcfce7] text-[#166534] px-4 py-2 rounded-xl text-sm font-semibold hover:bg-[#bbf7d0] transition-colors"><Download /> Backup</button>
                                <label className="flex items-center gap-2 bg-[#ffedd5] text-[#9a3412] px-4 py-2 rounded-xl text-sm font-semibold hover:bg-[#fed7aa] cursor-pointer transition-colors">
                                    <Upload /> Restore <input type="file" className="hidden" onChange={importJSON} />
                                </label>
                                <button onClick={exportExcel} className="flex items-center gap-2 bg-[#e0e7ff] text-[#3730a3] px-4 py-2 rounded-xl text-sm font-semibold hover:bg-[#c7d2fe] transition-colors"><Download /> Excel</button>
                            </div>
                        </div>
                    </div>

                    <div className="flex gap-4 mb-8">
                        <select value={currentMonth} onChange={(e) => setCurrentMonth(Number(e.target.value))} className="p-3 px-6 rounded-2xl border-none shadow-sm font-semibold bg-white text-gray-600 focus:ring-2 focus:ring-[#e0e7ff] outline-none cursor-pointer">
                            {MONTHS.map((m, i) => <option key={m} value={i}>{m}</option>)}
                        </select>
                        <div className="flex bg-[#f1f5f9] p-1.5 rounded-2xl">
                            <button onClick={() => setCurrentView('daily')} className={`px-8 py-2.5 rounded-xl font-bold transition-all ${currentView === 'daily' ? 'bg-white text-[#6366f1] shadow-sm' : 'text-gray-400'}`}>Daily</button>
                            <button onClick={() => setCurrentView('monthly')} className={`px-8 py-2.5 rounded-xl font-bold transition-all ${currentView === 'monthly' ? 'bg-white text-[#6366f1] shadow-sm' : 'text-gray-400'}`}>Summary</button>
                        </div>
                    </div>

                    {currentView === 'daily' ? (
                        <div className="space-y-4">
                            {Array.from({ length: getDaysInMonth(currentMonth) }, (_, i) => i + 1)
                                .sort((a, b) => {
                                    const aD = isDayDone(currentMonth, a);
                                    const bD = isDayDone(currentMonth, b);
                                    return aD === bD ? a - b : (aD ? 1 : -1);
                                })
                                .map(day => {
                                    const done = isDayDone(currentMonth, day);
                                    const isWeekend = timesheet.weekends[currentMonth]?.[day];
                                    const collapsed = collapsedDays[day];

                                    return (
                                        <div key={day} className={`bg-white rounded-2xl shadow-sm border transition-all ${isWeekend ? 'border-[#fed7aa] bg-[#fffaf5]' : done ? 'border-[#dcfce7] bg-[#fdfdfd]' : 'border-[#f1f5f9]'}`}>
                                            <div className="p-5 flex items-center justify-between cursor-pointer" onClick={() => done && setCollapsedDays(p => ({...p, [day]: !p[day]}))}>
                                                <div className="flex items-center gap-5">
                                                    <span className="font-bold text-[#cbd5e1] text-lg">#{day}</span>
                                                    <h3 className="font-semibold text-gray-700">{MONTHS[currentMonth]} {day}</h3>
                                                    {isWeekend && <span className="bg-[#ffedd5] text-[#c2410c] text-[10px] px-3 py-1 rounded-full font-bold uppercase tracking-wider">Off</span>}
                                                    {!isWeekend && done && <span className="bg-[#dcfce7] text-[#15803d] text-[10px] px-3 py-1 rounded-full font-bold uppercase tracking-wider">Done</span>}
                                                </div>
                                                <div className="flex items-center gap-4" onClick={e => e.stopPropagation()}>
                                                    <label className="text-[11px] font-bold text-gray-500 flex items-center gap-2 cursor-pointer bg-white border border-[#f1f5f9] px-3 py-1.5 rounded-xl hover:bg-gray-50 transition-colors">
                                                        <input type="checkbox" checked={!!isWeekend} onChange={() => toggleWeekend(currentMonth, day)} className="accent-[#fb923c]" /> OFF-DAY
                                                    </label>
                                                    {!done && !isWeekend && (
                                                        <select onChange={(e) => bulkUpdate(currentMonth, day, e.target.value)} value="" className="text-[11px] border border-[#f1f5f9] px-2 py-1.5 rounded-xl outline-none bg-white font-medium text-gray-500">
                                                            <option value="">Bulk Fill</option>
                                                            {CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}
                                                        </select>
                                                    )}
                                                    <button onClick={() => clearDay(currentMonth, day)} className="p-2 text-[#fda4af] hover:text-[#f43f5e] transition-colors"><Trash2 /></button>
                                                    {done && (collapsed ? <ChevronDown /> : <ChevronUp />)}
                                                </div>
                                            </div>
                                            {(!done || !collapsed) && !isWeekend && (
                                                <div className="p-6 pt-0 grid grid-cols-1 md:grid-cols-4 gap-4 border-t border-[#fcfcfc] mt-2">
                                                    {HOURS.map(h => (
                                                        <div key={h} className="flex flex-col">
                                                            <span className="text-[10px] font-bold text-[#94a3b8] mb-1.5 ml-1">{h}</span>
                                                            <select 
                                                                value={timesheet.data[currentMonth]?.[day]?.[h] || ''} 
                                                                onChange={(e) => updateActivity(currentMonth, day, h, e.target.value)}
                                                                className="text-xs p-2.5 border border-[#f1f5f9] rounded-xl bg-[#f8fafc] focus:bg-white focus:ring-2 focus:ring-[#e0e7ff] outline-none transition-all text-gray-600 font-medium"
                                                            >
                                                                <option value="">--</option>
                                                                {CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}
                                                            </select>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                        </div>
                    ) : renderMonthlySummary()}
                </div>
            );
        }

        ReactDOM.render(<TimesheetTracker />, document.getElementById('root'));
    </script>
</body>
</html>


